import random from './random.js';

function OpenSimplex(stdlib, foreign, heap) {
  'use asm';
  var imul = stdlib.Math.imul;
  var floor = stdlib.Math.floor;

  var _setSeed = foreign.setSeed;
  var nextU32 = foreign.nextUint32;

  var heapU16 = new stdlib.Uint16Array(heap);
  var heapU32 = new stdlib.Uint32Array(heap);
  var heapI32 = new stdlib.Int32Array(heap);
  var heapF64 = new stdlib.Float64Array(heap);

  var pSize = 0x800;
  var pMask = 0x7ff;

  var X = 0x00;
  var Y = 0x08;
  var Z = 0x10;
  var W = 0x18;

  var XI = 0x0;
  var YI = 0x4;
  var ZI = 0x8;
  var WI = 0xc;

  var contribution2D = 0x18; // 2 * 8 bytes + 2 * 4 bytes
  var contribution3D = 0x28; // 3 * 8 bytes + 3 * 4 bytes
  var contribution4D = 0x30; // 4 * 8 bytes + 4 * 4 bytes

  var perm = 0x0; // 2048 permutations * 2 byte

  var stretchConstant2D = 0x1000;
  var stretchConstant3D = 0x1008;
  var stretchConstant4D = 0x1010;

  var squishConstant2D = 0x1018;
  var squishConstant3D = 0x1020;
  var squishConstant4D = 0x1028;

  var gradients2D = 0x01030; // 2048 gradients * 2 dimensions * 8 bytes
  var gradients3D = 0x09030; // 2048 gradients * 3 dimensions * 8 bytes
  var gradients4D = 0x15030; // 2048 gradients * 4 dimensions * 8 bytes

  var lookUp2D = 0x25030; // 64 * 4 bytes
  var contributions2D = 0x25130; // 24 * (2 * 8 bytes + 2 * 4 bytes)

  var lookUp3D = 0x25370; // 2048 * 4 bytes
  var contributions3D = 0x27370; // 8*24 * (3 * 4 bytes + 3 * 8 bytes)

  function normalize(n) {
    n = +n;
    return (n + 1.0) / 2.0;
  }

  function setSeed(value) {
    value = +value;
    var i = 0;
    var r = 0;
    var temp = 0;

    _setSeed(value);

    for (i = 0; (i | 0) < (pSize | 0); i = (i + 1) | 0) {
      heapU16[(perm + (i << 1)) >> 1] = i;
    }
    for (i = 0; (i | 0) < (pSize | 0); i = (i + 1) | 0) {
      r = (nextU32() | 0) & pMask;
      temp = getPerm(i) | 0;
      heapU16[(perm + (i << 1)) >> 1] = getPerm(r) | 0;
      heapU16[(perm + (r << 1)) >> 1] = temp;
    }
  }

  function getPerm(i) {
    i = i | 0;
    return heapU16[(perm + (i << 1)) >> 1] | 0;
  }

  function grad2D(xsb, ysb, dx, dy) {
    xsb = xsb | 0;
    ysb = ysb | 0;
    dx = +dx;
    dy = +dy;
    var i = 0;
    i = (getPerm(xsb & pMask) | 0) ^ (ysb & pMask);
    i = getPerm(i) | 0;
    return +heapF64[(gradients2D + (i << 4) + X) >> 3] * dx + +heapF64[(gradients2D + (i << 4) + Y) >> 3] * dy;
  }

  function eval2D(x, y) {
    x = +x;
    y = +y;
    var stretchOffset = 0.0;
    var xs = 0.0;
    var ys = 0.0;
    var xsb = 0;
    var ysb = 0;
    var xins = 0.0;
    var yins = 0.0;
    var inSum = 0.0;
    var squishOffsetIns = 0.0;
    var dx0 = 0.0;
    var dy0 = 0.0;
    var hash = 0;
    var offset = 0;
    var i = 0;
    var c = 0;
    var dx = 0.0;
    var dy = 0.0;
    var px = 0;
    var py = 0;
    var attn = 0.0;
    var value = 0.0;

    stretchOffset = (x + y) * heapF64[stretchConstant2D >> 3];
    xs = x + stretchOffset;
    ys = y + stretchOffset;

    xsb = ~~floor(xs);
    ysb = ~~floor(ys);

    xins = xs - +(xsb | 0);
    yins = ys - +(ysb | 0);

    inSum = xins + yins;

    squishOffsetIns = inSum * heapF64[squishConstant2D >> 3];
    dx0 = xins + squishOffsetIns;
    dy0 = yins + squishOffsetIns;

    // prettier-ignore
    hash = 
      ~~floor(xins - yins + 1.0) |
      (~~floor(inSum) << 1) |
      (~~floor(inSum + yins) << 2) |
      (~~floor(inSum + xins) << 4);

    offset = imul(contribution2D, heapU32[(lookUp2D + (hash << 2)) >> 2] | 0) << 2;

    for (i = 0; (i | 0) < 4; i = (i + 1) | 0) {
      c = imul(contribution2D, i);
      dx = dx0 + +heapF64[(contributions2D + offset + c + X) >> 3];
      dy = dy0 + +heapF64[(contributions2D + offset + c + Y) >> 3];
      attn = 2.0 - dx * dx - dy * dy;
      if (attn > 0.0) {
        px = xsb + heapI32[(contributions2D + offset + c + 0x10 + XI) >> 2];
        py = ysb + heapI32[(contributions2D + offset + c + 0x10 + YI) >> 2];

        attn = attn * attn;
        value = value + attn * attn * +grad2D(px, py, dx, dy);
      }
    }
    return +normalize(value);
  }

  function grad3D(xsb, ysb, zsb, dx, dy, dz) {
    xsb = xsb | 0;
    ysb = ysb | 0;
    zsb = zsb | 0;
    dx = +dx;
    dy = +dy;
    dz = +dz;
    var i = 0;
    i = (getPerm(xsb & pMask) | 0) ^ (ysb & pMask);
    i = (getPerm(i) | 0) ^ (zsb & pMask);
    i = getPerm(i) | 0;
    i = imul(i, 3);
    return (
      +heapF64[(gradients3D + (i << 3) + X) >> 3] * dx +
      +heapF64[(gradients3D + (i << 3) + Y) >> 3] * dy +
      +heapF64[(gradients3D + (i << 3) + Z) >> 3] * dz
    );
  }

  function eval3D(x, y, z) {
    x = +x;
    y = +y;
    z = +z;
    var stretchOffset = 0.0;
    var xs = 0.0;
    var ys = 0.0;
    var zs = 0.0;

    stretchOffset = (x + y + z) * heapF64[stretchConstant3D >> 3];
    xs = x + stretchOffset;
    ys = y + stretchOffset;
    zs = z + stretchOffset;

    return +eval3DBase(xs, ys, zs);
  }

  function eval3DXYBeforeZ(x, y, z) {
    x = +x;
    y = +y;
    z = +z;
    var xy = 0.0;
    var s2 = 0.0;
    var zz = 0.0;
    var xs = 0.0;
    var ys = 0.0;
    var zs = 0.0;
    xy = x + y;
    s2 = xy * -heapF64[stretchConstant2D >> 3];
    zz = z * 0.288675134594813;
    xs = s2 - x + zz;
    ys = s2 - y + zz;
    zs = xy * 0.577350269189626 + zz;

    return +eval3DBase(xs, ys, zs);
  }

  function eval3DXZBeforeY(x, y, z) {
    x = +x;
    y = +y;
    z = +z;
    var xz = 0.0;
    var s2 = 0.0;
    var yy = 0.0;
    var xs = 0.0;
    var ys = 0.0;
    var zs = 0.0;
    xz = x + z;
    s2 = xz * -heapF64[stretchConstant2D >> 3];
    yy = y * 0.288675134594813;
    xs = s2 - x + yy;
    ys = xz * 0.577350269189626 + yy;
    zs = s2 - z + yy;

    return +eval3DBase(xs, ys, zs);
  }

  function eval3DBase(xs, ys, zs) {
    xs = +xs;
    ys = +ys;
    zs = +zs;
    var xsb = 0;
    var ysb = 0;
    var zsb = 0;
    var xins = 0.0;
    var yins = 0.0;
    var zins = 0.0;
    var inSum = 0.0;
    var squishOffsetIns = 0.0;
    var dx0 = 0.0;
    var dy0 = 0.0;
    var dz0 = 0.0;
    var hash = 0;
    var offset = 0;
    var length = 0;
    var i = 0;
    var c = 0;
    var dx = 0.0;
    var dy = 0.0;
    var dz = 0.0;
    var px = 0;
    var py = 0;
    var pz = 0;
    var attn = 0.0;
    var value = 0.0;

    xsb = ~~floor(xs);
    ysb = ~~floor(ys);
    zsb = ~~floor(zs);

    xins = xs - +(xsb | 0);
    yins = ys - +(ysb | 0);
    zins = zs - +(zsb | 0);

    inSum = xins + yins + zins;

    squishOffsetIns = inSum * heapF64[squishConstant3D >> 3];
    dx0 = xins + squishOffsetIns;
    dy0 = yins + squishOffsetIns;
    dz0 = zins + squishOffsetIns;

    hash =
      ~~floor(yins - zins + 1.0) |
      (~~floor(xins - yins + 1.0) << 1) |
      (~~floor(xins - zins + 1.0) << 2) |
      (~~floor(inSum) << 3) |
      (~~floor(inSum + zins) << 5) |
      (~~floor(inSum + yins) << 7) |
      (~~floor(inSum + xins) << 9);

    offset = imul((1 + contribution3D) | 0, heapU32[(lookUp3D + (hash << 2)) >> 2] | 0) << 3;
    length = heapU32[(contributions3D + offset) >> 2] | 0;
    offset = (offset + 0x8) | 0;

    for (i = 0; (i | 0) < (length | 0); i = (i + 1) | 0) {
      c = imul(contribution3D, i);
      dx = dx0 + +heapF64[(contributions3D + offset + c + X) >> 3];
      dy = dy0 + +heapF64[(contributions3D + offset + c + Y) >> 3];
      dz = dz0 + +heapF64[(contributions3D + offset + c + Z) >> 3];
      attn = 2.0 - dx * dx - dy * dy - dz * dz;
      if (attn > 0.0) {
        px = xsb + heapI32[(contributions3D + offset + c + 0x18 + XI) >> 2];
        py = ysb + heapI32[(contributions3D + offset + c + 0x18 + YI) >> 2];
        pz = zsb + heapI32[(contributions3D + offset + c + 0x18 + ZI) >> 2];

        attn = attn * attn;
        value = value + attn * attn * +grad3D(px, py, pz, dx, dy, dz);
      }
    }
    return +normalize(value);
  }

  return {
    setSeed: setSeed,
    eval2D: eval2D,
    eval3D: eval3D,
  };
}

const heap = new ArrayBuffer(0x100000);

// set constants
{
  const heapF64 = new Float64Array(heap, 0x800 * 2);
  heapF64[0 + 0] = (1 / Math.sqrt(2 + 1) - 1) / 2; // stretch constant 2d
  heapF64[3 + 0] = (Math.sqrt(2 + 1) - 1) / 2; // squish constant 2d
  heapF64[0 + 1] = (1 / Math.sqrt(3 + 1) - 1) / 3; // stretch constant 3d
  heapF64[3 + 1] = (Math.sqrt(3 + 1) - 1) / 3; // squish constant 3d
  heapF64[0 + 2] = (1 / Math.sqrt(4 + 1) - 1) / 4; // stretch constant 4d
  heapF64[3 + 2] = (Math.sqrt(4 + 1) - 1) / 4; // squish constant 4d
}

// create gradients
{
  const heapF64 = new Float64Array(heap, 0x800 * 2 + 6 * 0x8);

  let offset = 0;
  {
    // prettier-ignore
    const gradients2D = [
      0.130526192220052, 0.99144486137381,
      0.38268343236509, 0.923879532511287,
      0.608761429008721, 0.793353340291235,
      0.793353340291235, 0.608761429008721,
      0.923879532511287, 0.38268343236509,
      0.99144486137381, 0.130526192220051,
      0.99144486137381, -0.130526192220051,
      0.923879532511287, -0.38268343236509,
      0.793353340291235, -0.60876142900872,
      0.608761429008721, -0.793353340291235,
      0.38268343236509, -0.923879532511287,
      0.130526192220052, -0.99144486137381,
      -0.130526192220052, -0.99144486137381,
      -0.38268343236509, -0.923879532511287,
      -0.608761429008721, -0.793353340291235,
      -0.793353340291235, -0.608761429008721,
      -0.923879532511287, -0.38268343236509,
      -0.99144486137381, -0.130526192220052,
      -0.99144486137381, 0.130526192220051,
      -0.923879532511287, 0.38268343236509,
      -0.793353340291235, 0.608761429008721,
      -0.608761429008721, 0.793353340291235,
      -0.38268343236509, 0.923879532511287,
      -0.130526192220052, 0.99144486137381,
    ].map((n) => n / 7.69084574549313);

    for (let i = 0; i < 2 * 0x800; i++) {
      heapF64[offset + i] = gradients2D[i % gradients2D.length];
    }
    offset += 2 * 0x800;
  }

  {
    // prettier-ignore
    const gradients3D = [
      -1.4082482904633333,  -1.4082482904633333,  -2.6329931618533333,
      -0.07491495712999985,  -0.07491495712999985,  -3.29965982852,
      0.24732126143473554,  -1.6667938651159684,  -2.838945207362466,
      -1.6667938651159684,  0.24732126143473554,  -2.838945207362466,
      -1.4082482904633333,  -2.6329931618533333,  -1.4082482904633333,
      -0.07491495712999985,  -3.29965982852,  -0.07491495712999985,
      -1.6667938651159684,  -2.838945207362466,  0.24732126143473554,
      0.24732126143473554,  -2.838945207362466,  -1.6667938651159684,
      1.5580782047233335,  0.33333333333333337,  -2.8914115380566665,
      2.8914115380566665,  -0.33333333333333337,  -1.5580782047233335,
      1.8101897177633992,  -1.2760767510338025,  -2.4482280932803,
      2.4482280932803,  1.2760767510338025,  -1.8101897177633992,
      1.5580782047233335,  -2.8914115380566665,  0.33333333333333337,
      2.8914115380566665,  -1.5580782047233335,  -0.33333333333333337,
      2.4482280932803,  -1.8101897177633992,  1.2760767510338025,
      1.8101897177633992,  -2.4482280932803,  -1.2760767510338025,
      -2.6329931618533333,  -1.4082482904633333,  -1.4082482904633333,
      -3.29965982852,  -0.07491495712999985,  -0.07491495712999985,
      -2.838945207362466,  0.24732126143473554,  -1.6667938651159684,
      -2.838945207362466,  -1.6667938651159684,  0.24732126143473554,
      0.33333333333333337,  1.5580782047233335,  -2.8914115380566665,
      -0.33333333333333337,  2.8914115380566665,  -1.5580782047233335,
      1.2760767510338025,  2.4482280932803,  -1.8101897177633992,
      -1.2760767510338025,  1.8101897177633992,  -2.4482280932803,
      0.33333333333333337,  -2.8914115380566665,  1.5580782047233335,
      -0.33333333333333337,  -1.5580782047233335,  2.8914115380566665,
      -1.2760767510338025,  -2.4482280932803,  1.8101897177633992,
      1.2760767510338025,  -1.8101897177633992,  2.4482280932803,
      3.29965982852,  0.07491495712999985,  0.07491495712999985,
      2.6329931618533333,  1.4082482904633333,  1.4082482904633333,
      2.838945207362466,  -0.24732126143473554,  1.6667938651159684,
      2.838945207362466,  1.6667938651159684,  -0.24732126143473554,
      -2.8914115380566665,  1.5580782047233335,  0.33333333333333337,
      -1.5580782047233335,  2.8914115380566665,  -0.33333333333333337,
      -2.4482280932803,  1.8101897177633992,  -1.2760767510338025,
      -1.8101897177633992,  2.4482280932803,  1.2760767510338025,
      -2.8914115380566665,  0.33333333333333337,  1.5580782047233335,
      -1.5580782047233335,  -0.33333333333333337,  2.8914115380566665,
      -1.8101897177633992,  1.2760767510338025,  2.4482280932803,
      -2.4482280932803,  -1.2760767510338025,  1.8101897177633992,
      0.07491495712999985,  3.29965982852,  0.07491495712999985,
      1.4082482904633333,  2.6329931618533333,  1.4082482904633333,
      1.6667938651159684,  2.838945207362466,  -0.24732126143473554,
      -0.24732126143473554,  2.838945207362466,  1.6667938651159684,
      0.07491495712999985,  0.07491495712999985,  3.29965982852,
      1.4082482904633333,  1.4082482904633333,  2.6329931618533333,
      -0.24732126143473554,  1.6667938651159684,  2.838945207362466,
      1.6667938651159684,  -0.24732126143473554,  2.838945207362466
    ].map((n) => n / 26.92263139946168);

    for (let i = 0; i < 3 * 0x800; i++) {
      heapF64[offset + i] = gradients3D[i % gradients3D.length];
    }
    offset += 3 * 0x800;
  }

  {
    // prettier-ignore
    const gradients4D = [
      -0.753341017856078, -0.37968289875261624, -0.37968289875261624, -0.37968289875261624,
      -0.7821684431180708, -0.4321472685365301, -0.4321472685365301, 0.12128480194602098,
      -0.7821684431180708, -0.4321472685365301, 0.12128480194602098, -0.4321472685365301,
      -0.7821684431180708, 0.12128480194602098, -0.4321472685365301, -0.4321472685365301,
      -0.8586508742123365, -0.508629699630796, 0.044802370851755174, 0.044802370851755174,
      -0.8586508742123365, 0.044802370851755174, -0.508629699630796, 0.044802370851755174,
      -0.8586508742123365, 0.044802370851755174, 0.044802370851755174, -0.508629699630796,
      -0.9982828964265062, -0.03381941603233842, -0.03381941603233842, -0.03381941603233842,
      -0.37968289875261624, -0.753341017856078, -0.37968289875261624, -0.37968289875261624,
      -0.4321472685365301, -0.7821684431180708, -0.4321472685365301, 0.12128480194602098,
      -0.4321472685365301, -0.7821684431180708, 0.12128480194602098, -0.4321472685365301,
      0.12128480194602098, -0.7821684431180708, -0.4321472685365301, -0.4321472685365301,
      -0.508629699630796, -0.8586508742123365, 0.044802370851755174, 0.044802370851755174,
      0.044802370851755174, -0.8586508742123365, -0.508629699630796, 0.044802370851755174,
      0.044802370851755174, -0.8586508742123365, 0.044802370851755174, -0.508629699630796,
      -0.03381941603233842, -0.9982828964265062, -0.03381941603233842, -0.03381941603233842,
      -0.37968289875261624, -0.37968289875261624, -0.753341017856078, -0.37968289875261624,
      -0.4321472685365301, -0.4321472685365301, -0.7821684431180708, 0.12128480194602098,
      -0.4321472685365301, 0.12128480194602098, -0.7821684431180708, -0.4321472685365301,
      0.12128480194602098, -0.4321472685365301, -0.7821684431180708, -0.4321472685365301,
      -0.508629699630796, 0.044802370851755174, -0.8586508742123365, 0.044802370851755174,
      0.044802370851755174, -0.508629699630796, -0.8586508742123365, 0.044802370851755174,
      0.044802370851755174, 0.044802370851755174, -0.8586508742123365, -0.508629699630796,
      -0.03381941603233842, -0.03381941603233842, -0.9982828964265062, -0.03381941603233842,
      -0.37968289875261624, -0.37968289875261624, -0.37968289875261624, -0.753341017856078,
      -0.4321472685365301, -0.4321472685365301, 0.12128480194602098, -0.7821684431180708,
      -0.4321472685365301, 0.12128480194602098, -0.4321472685365301, -0.7821684431180708,
      0.12128480194602098, -0.4321472685365301, -0.4321472685365301, -0.7821684431180708,
      -0.508629699630796, 0.044802370851755174, 0.044802370851755174, -0.8586508742123365,
      0.044802370851755174, -0.508629699630796, 0.044802370851755174, -0.8586508742123365,
      0.044802370851755174, 0.044802370851755174, -0.508629699630796, -0.8586508742123365,
      -0.03381941603233842, -0.03381941603233842, -0.03381941603233842, -0.9982828964265062,
      -0.6740059517812944, -0.3239847771997537, -0.3239847771997537, 0.5794684678643381,
      -0.7504883828755602, -0.4004672082940195, 0.15296486218853164, 0.5029860367700724,
      -0.7504883828755602, 0.15296486218853164, -0.4004672082940195, 0.5029860367700724,
      -0.8828161875373585, 0.08164729285680945, 0.08164729285680945, 0.4553054119602712,
      -0.4553054119602712, -0.08164729285680945, -0.08164729285680945, 0.8828161875373585,
      -0.5029860367700724, -0.15296486218853164, 0.4004672082940195, 0.7504883828755602,
      -0.5029860367700724, 0.4004672082940195, -0.15296486218853164, 0.7504883828755602,
      -0.5794684678643381, 0.3239847771997537, 0.3239847771997537, 0.6740059517812944,
      -0.3239847771997537, -0.6740059517812944, -0.3239847771997537, 0.5794684678643381,
      -0.4004672082940195, -0.7504883828755602, 0.15296486218853164, 0.5029860367700724,
      0.15296486218853164, -0.7504883828755602, -0.4004672082940195, 0.5029860367700724,
      0.08164729285680945, -0.8828161875373585, 0.08164729285680945, 0.4553054119602712,
      -0.08164729285680945, -0.4553054119602712, -0.08164729285680945, 0.8828161875373585,
      -0.15296486218853164, -0.5029860367700724, 0.4004672082940195, 0.7504883828755602,
      0.4004672082940195, -0.5029860367700724, -0.15296486218853164, 0.7504883828755602,
      0.3239847771997537, -0.5794684678643381, 0.3239847771997537, 0.6740059517812944,
      -0.3239847771997537, -0.3239847771997537, -0.6740059517812944, 0.5794684678643381,
      -0.4004672082940195, 0.15296486218853164, -0.7504883828755602, 0.5029860367700724,
      0.15296486218853164, -0.4004672082940195, -0.7504883828755602, 0.5029860367700724,
      0.08164729285680945, 0.08164729285680945, -0.8828161875373585, 0.4553054119602712,
      -0.08164729285680945, -0.08164729285680945, -0.4553054119602712, 0.8828161875373585,
      -0.15296486218853164, 0.4004672082940195, -0.5029860367700724, 0.7504883828755602,
      0.4004672082940195, -0.15296486218853164, -0.5029860367700724, 0.7504883828755602,
      0.3239847771997537, 0.3239847771997537, -0.5794684678643381, 0.6740059517812944,
      -0.6740059517812944, -0.3239847771997537, 0.5794684678643381, -0.3239847771997537,
      -0.7504883828755602, -0.4004672082940195, 0.5029860367700724, 0.15296486218853164,
      -0.7504883828755602, 0.15296486218853164, 0.5029860367700724, -0.4004672082940195,
      -0.8828161875373585, 0.08164729285680945, 0.4553054119602712, 0.08164729285680945,
      -0.4553054119602712, -0.08164729285680945, 0.8828161875373585, -0.08164729285680945,
      -0.5029860367700724, -0.15296486218853164, 0.7504883828755602, 0.4004672082940195,
      -0.5029860367700724, 0.4004672082940195, 0.7504883828755602, -0.15296486218853164,
      -0.5794684678643381, 0.3239847771997537, 0.6740059517812944, 0.3239847771997537,
      -0.3239847771997537, -0.6740059517812944, 0.5794684678643381, -0.3239847771997537,
      -0.4004672082940195, -0.7504883828755602, 0.5029860367700724, 0.15296486218853164,
      0.15296486218853164, -0.7504883828755602, 0.5029860367700724, -0.4004672082940195,
      0.08164729285680945, -0.8828161875373585, 0.4553054119602712, 0.08164729285680945,
      -0.08164729285680945, -0.4553054119602712, 0.8828161875373585, -0.08164729285680945,
      -0.15296486218853164, -0.5029860367700724, 0.7504883828755602, 0.4004672082940195,
      0.4004672082940195, -0.5029860367700724, 0.7504883828755602, -0.15296486218853164,
      0.3239847771997537, -0.5794684678643381, 0.6740059517812944, 0.3239847771997537,
      -0.3239847771997537, -0.3239847771997537, 0.5794684678643381, -0.6740059517812944,
      -0.4004672082940195, 0.15296486218853164, 0.5029860367700724, -0.7504883828755602,
      0.15296486218853164, -0.4004672082940195, 0.5029860367700724, -0.7504883828755602,
      0.08164729285680945, 0.08164729285680945, 0.4553054119602712, -0.8828161875373585,
      -0.08164729285680945, -0.08164729285680945, 0.8828161875373585, -0.4553054119602712,
      -0.15296486218853164, 0.4004672082940195, 0.7504883828755602, -0.5029860367700724,
      0.4004672082940195, -0.15296486218853164, 0.7504883828755602, -0.5029860367700724,
      0.3239847771997537, 0.3239847771997537, 0.6740059517812944, -0.5794684678643381,
      -0.6740059517812944, 0.5794684678643381, -0.3239847771997537, -0.3239847771997537,
      -0.7504883828755602, 0.5029860367700724, -0.4004672082940195, 0.15296486218853164,
      -0.7504883828755602, 0.5029860367700724, 0.15296486218853164, -0.4004672082940195,
      -0.8828161875373585, 0.4553054119602712, 0.08164729285680945, 0.08164729285680945,
      -0.4553054119602712, 0.8828161875373585, -0.08164729285680945, -0.08164729285680945,
      -0.5029860367700724, 0.7504883828755602, -0.15296486218853164, 0.4004672082940195,
      -0.5029860367700724, 0.7504883828755602, 0.4004672082940195, -0.15296486218853164,
      -0.5794684678643381, 0.6740059517812944, 0.3239847771997537, 0.3239847771997537,
      -0.3239847771997537, 0.5794684678643381, -0.6740059517812944, -0.3239847771997537,
      -0.4004672082940195, 0.5029860367700724, -0.7504883828755602, 0.15296486218853164,
      0.15296486218853164, 0.5029860367700724, -0.7504883828755602, -0.4004672082940195,
      0.08164729285680945, 0.4553054119602712, -0.8828161875373585, 0.08164729285680945,
      -0.08164729285680945, 0.8828161875373585, -0.4553054119602712, -0.08164729285680945,
      -0.15296486218853164, 0.7504883828755602, -0.5029860367700724, 0.4004672082940195,
      0.4004672082940195, 0.7504883828755602, -0.5029860367700724, -0.15296486218853164,
      0.3239847771997537, 0.6740059517812944, -0.5794684678643381, 0.3239847771997537,
      -0.3239847771997537, 0.5794684678643381, -0.3239847771997537, -0.6740059517812944,
      -0.4004672082940195, 0.5029860367700724, 0.15296486218853164, -0.7504883828755602,
      0.15296486218853164, 0.5029860367700724, -0.4004672082940195, -0.7504883828755602,
      0.08164729285680945, 0.4553054119602712, 0.08164729285680945, -0.8828161875373585,
      -0.08164729285680945, 0.8828161875373585, -0.08164729285680945, -0.4553054119602712,
      -0.15296486218853164, 0.7504883828755602, 0.4004672082940195, -0.5029860367700724,
      0.4004672082940195, 0.7504883828755602, -0.15296486218853164, -0.5029860367700724,
      0.3239847771997537, 0.6740059517812944, 0.3239847771997537, -0.5794684678643381,
      0.5794684678643381, -0.6740059517812944, -0.3239847771997537, -0.3239847771997537,
      0.5029860367700724, -0.7504883828755602, -0.4004672082940195, 0.15296486218853164,
      0.5029860367700724, -0.7504883828755602, 0.15296486218853164, -0.4004672082940195,
      0.4553054119602712, -0.8828161875373585, 0.08164729285680945, 0.08164729285680945,
      0.8828161875373585, -0.4553054119602712, -0.08164729285680945, -0.08164729285680945,
      0.7504883828755602, -0.5029860367700724, -0.15296486218853164, 0.4004672082940195,
      0.7504883828755602, -0.5029860367700724, 0.4004672082940195, -0.15296486218853164,
      0.6740059517812944, -0.5794684678643381, 0.3239847771997537, 0.3239847771997537,
      0.5794684678643381, -0.3239847771997537, -0.6740059517812944, -0.3239847771997537,
      0.5029860367700724, -0.4004672082940195, -0.7504883828755602, 0.15296486218853164,
      0.5029860367700724, 0.15296486218853164, -0.7504883828755602, -0.4004672082940195,
      0.4553054119602712, 0.08164729285680945, -0.8828161875373585, 0.08164729285680945,
      0.8828161875373585, -0.08164729285680945, -0.4553054119602712, -0.08164729285680945,
      0.7504883828755602, -0.15296486218853164, -0.5029860367700724, 0.4004672082940195,
      0.7504883828755602, 0.4004672082940195, -0.5029860367700724, -0.15296486218853164,
      0.6740059517812944, 0.3239847771997537, -0.5794684678643381, 0.3239847771997537,
      0.5794684678643381, -0.3239847771997537, -0.3239847771997537, -0.6740059517812944,
      0.5029860367700724, -0.4004672082940195, 0.15296486218853164, -0.7504883828755602,
      0.5029860367700724, 0.15296486218853164, -0.4004672082940195, -0.7504883828755602,
      0.4553054119602712, 0.08164729285680945, 0.08164729285680945, -0.8828161875373585,
      0.8828161875373585, -0.08164729285680945, -0.08164729285680945, -0.4553054119602712,
      0.7504883828755602, -0.15296486218853164, 0.4004672082940195, -0.5029860367700724,
      0.7504883828755602, 0.4004672082940195, -0.15296486218853164, -0.5029860367700724,
      0.6740059517812944, 0.3239847771997537, 0.3239847771997537, -0.5794684678643381,
      0.03381941603233842, 0.03381941603233842, 0.03381941603233842, 0.9982828964265062,
      -0.044802370851755174, -0.044802370851755174, 0.508629699630796, 0.8586508742123365,
      -0.044802370851755174, 0.508629699630796, -0.044802370851755174, 0.8586508742123365,
      -0.12128480194602098, 0.4321472685365301, 0.4321472685365301, 0.7821684431180708,
      0.508629699630796, -0.044802370851755174, -0.044802370851755174, 0.8586508742123365,
      0.4321472685365301, -0.12128480194602098, 0.4321472685365301, 0.7821684431180708,
      0.4321472685365301, 0.4321472685365301, -0.12128480194602098, 0.7821684431180708,
      0.37968289875261624, 0.37968289875261624, 0.37968289875261624, 0.753341017856078,
      0.03381941603233842, 0.03381941603233842, 0.9982828964265062, 0.03381941603233842,
      -0.044802370851755174, 0.044802370851755174, 0.8586508742123365, 0.508629699630796,
      -0.044802370851755174, 0.508629699630796, 0.8586508742123365, -0.044802370851755174,
      -0.12128480194602098, 0.4321472685365301, 0.7821684431180708, 0.4321472685365301,
      0.508629699630796, -0.044802370851755174, 0.8586508742123365, -0.044802370851755174,
      0.4321472685365301, -0.12128480194602098, 0.7821684431180708, 0.4321472685365301,
      0.4321472685365301, 0.4321472685365301, 0.7821684431180708, -0.12128480194602098,
      0.37968289875261624, 0.37968289875261624, 0.753341017856078, 0.37968289875261624,
      0.03381941603233842, 0.9982828964265062, 0.03381941603233842, 0.03381941603233842,
      -0.044802370851755174, 0.8586508742123365, -0.044802370851755174, 0.508629699630796,
      -0.044802370851755174, 0.8586508742123365, 0.508629699630796, -0.044802370851755174,
      -0.12128480194602098, 0.7821684431180708, 0.4321472685365301, 0.4321472685365301,
      0.508629699630796, 0.8586508742123365, -0.044802370851755174, -0.044802370851755174,
      0.4321472685365301, 0.7821684431180708, -0.12128480194602098, 0.4321472685365301,
      0.4321472685365301, 0.7821684431180708, 0.4321472685365301, -0.12128480194602098,
      0.37968289875261624, 0.753341017856078, 0.37968289875261624, 0.37968289875261624,
      0.9982828964265062, 0.03381941603233842, 0.03381941603233842, 0.03381941603233842,
      0.8586508742123365, -0.044802370851755174, -0.044802370851755174, 0.508629699630796,
      0.8586508742123365, -0.044802370851755174, 0.508629699630796, -0.044802370851755174,
      0.7821684431180708, -0.12128480194602098, 0.4321472685365301, 0.4321472685365301,
      0.8586508742123365, 0.508629699630796, -0.044802370851755174, -0.044802370851755174,
      0.7821684431180708, 0.4321472685365301, -0.12128480194602098, 0.4321472685365301,
      0.7821684431180708, 0.4321472685365301, 0.4321472685365301, -0.12128480194602098,
      0.753341017856078, 0.37968289875261624, 0.37968289875261624, 0.37968289875261624,
    ].map((n) => n / 8.881759591352166);

    for (let i = 0; i < 4 * 0x800; i++) {
      heapF64[offset + i] = gradients4D[i % gradients4D.length];
    }
  }
}

// create look ups
{
  const heapU32 = new Uint32Array(heap, 0x800 * 2 + (6 + (2 + 3 + 4) * 0x800) * 8);
  const heapI32 = new Int32Array(heap, 0x800 * 2 + (6 + (2 + 3 + 4) * 0x800) * 8);
  const heapF64 = new Float64Array(heap, 0x800 * 2 + (6 + (2 + 3 + 4) * 0x800) * 8);

  let offset32 = 0;
  let offset64 = 0;
  {
    const lookupPairs2D = [0, 1, 1, 0, 4, 1, 17, 0, 20, 2, 21, 2, 22, 5, 23, 5, 26, 4, 39, 3, 42, 4, 43, 3];
    for (let i = 0; i < lookupPairs2D.length; i += 2) {
      heapU32[offset32 + lookupPairs2D[i]] = lookupPairs2D[i + 1];
    }
    offset32 += 32 * 2;
    offset64 += 32;

    const squish2D = (Math.sqrt(2 + 1) - 1) / 2;
    function setContribution2D(multiplier, xsb, ysb) {
      heapF64[offset64] = -xsb - multiplier * squish2D;
      heapF64[offset64 + 1] = -ysb - multiplier * squish2D;
      heapI32[offset32 + 2 * 2] = xsb;
      heapI32[offset32 + 2 * 2 + 1] = ysb;
      offset32 += 3 * 2;
      offset64 += 3;
    }

    const base2D = [
      [1, 1, 0, 1, 0, 1, 0, 0, 0],
      [1, 1, 0, 1, 0, 1, 2, 1, 1],
    ];
    const p2D = [0, 0, 1, -1, 0, 0, -1, 1, 0, 2, 1, 1, 1, 2, 2, 0, 1, 2, 0, 2, 1, 0, 0, 0];
    for (let i = 0; i < p2D.length; i += 4) {
      let offset = i;
      const baseSet = base2D[p2D[i]];
      for (let k = 0; k < baseSet.length; k += 3) {
        setContribution2D(baseSet[k], baseSet[k + 1], baseSet[k + 2]);
        offset++;
      }
      setContribution2D(p2D[i + 1], p2D[i + 2], p2D[i + 3]);
    }
  }

  {
    // prettier-ignore
    const lookupPairs3D = [0, 2, 1, 1, 2, 2, 5, 1, 6, 0, 7, 0, 32, 2, 34, 2, 129, 1, 133, 1, 160, 5, 161, 5, 518, 0, 519, 0, 546, 4, 550, 4, 645, 3, 647, 3, 672, 5, 673, 5, 674, 4, 677, 3, 678, 4, 679, 3, 680, 13, 681, 13, 682, 12, 685, 14, 686, 12, 687, 14, 712, 20, 714, 18, 809, 21, 813, 23, 840, 20, 841, 21, 1198, 19, 1199, 22, 1226, 18, 1230, 19, 1325, 23, 1327, 22, 1352, 15, 1353, 17, 1354, 15, 1357, 17, 1358, 16, 1359, 16, 1360, 11, 1361, 10, 1362, 11, 1365, 10, 1366, 9, 1367, 9, 1392, 11, 1394, 11, 1489, 10, 1493, 10, 1520, 8, 1521, 8, 1878, 9, 1879, 9, 1906, 7, 1910, 7, 2005, 6, 2007, 6, 2032, 8, 2033, 8, 2034, 7, 2037, 6, 2038, 7, 2039, 6];
    for (let i = 0; i < lookupPairs3D.length; i += 2) {
      heapU32[offset32 + lookupPairs3D[i]] = lookupPairs3D[i + 1];
    }

    offset32 += 2048;
    offset64 += 1024;

    const base3D = [
      [0, 0, 0, 0, 1, 1, 0, 0, 1, 0, 1, 0, 1, 0, 0, 1],
      [2, 1, 1, 0, 2, 1, 0, 1, 2, 0, 1, 1, 3, 1, 1, 1],
      [1, 1, 0, 0, 1, 0, 1, 0, 1, 0, 0, 1, 2, 1, 1, 0, 2, 1, 0, 1, 2, 0, 1, 1],
    ];
    // prettier-ignore
    const p3D = [0, 0, 1, -1, 0, 0, 1, 0, -1, 0, 0, -1, 1, 0, 0, 0, 1, -1, 0, 0, -1, 0, 1, 0, 0, -1, 1, 0, 2, 1, 1, 0, 1, 1, 1, -1, 0, 2, 1, 0, 1, 1, 1, -1, 1, 0, 2, 0, 1, 1, 1, -1, 1, 1, 1, 3, 2, 1, 0, 3, 1, 2, 0, 1, 3, 2, 0, 1, 3, 1, 0, 2, 1, 3, 0, 2, 1, 3, 0, 1, 2, 1, 1, 1, 0, 0, 2, 2, 0, 0, 1, 1, 0, 1, 0, 2, 0, 2, 0, 1, 1, 0, 0, 1, 2, 0, 0, 2, 2, 0, 0, 0, 0, 1, 1, -1, 1, 2, 0, 0, 0, 0, 1, -1, 1, 1, 2, 0, 0, 0, 0, 1, 1, 1, -1, 2, 3, 1, 1, 1, 2, 0, 0, 2, 2, 3, 1, 1, 1, 2, 2, 0, 0, 2, 3, 1, 1, 1, 2, 0, 2, 0, 2, 1, 1, -1, 1, 2, 0, 0, 2, 2, 1, 1, -1, 1, 2, 2, 0, 0, 2, 1, -1, 1, 1, 2, 0, 0, 2, 2, 1, -1, 1, 1, 2, 0, 2, 0, 2, 1, 1, 1, -1, 2, 2, 0, 0, 2, 1, 1, 1, -1, 2, 0, 2, 0];

    const squish3D = (Math.sqrt(3 + 1) - 1) / 3;
    function setContribution3D(multiplier, xsb, ysb, zsb) {
      heapF64[offset64 + 0] = -xsb - multiplier * squish3D;
      heapF64[offset64 + 1] = -ysb - multiplier * squish3D;
      heapF64[offset64 + 2] = -zsb - multiplier * squish3D;
      heapI32[offset32 + 3 * 2 + 0] = xsb;
      heapI32[offset32 + 3 * 2 + 1] = ysb;
      heapI32[offset32 + 3 * 2 + 2] = zsb;
      offset32 += 5 * 2;
      offset64 += 5;
    }

    for (let i = 0; i < p3D.length; i += 9) {
      const baseSet = base3D[p3D[i]];
      const length = baseSet.length / 4 + 2;
      heapU32[offset32] = length;
      offset32 += 1 * 2;
      offset64 += 1;
      for (let k = 0; k < baseSet.length; k += 4)
        setContribution3D(baseSet[k], baseSet[k + 1], baseSet[k + 2], baseSet[k + 3]);
      setContribution3D(p3D[i + 1], p3D[i + 2], p3D[i + 3], p3D[i + 4]);
      setContribution3D(p3D[i + 5], p3D[i + 6], p3D[i + 7], p3D[i + 8]);
      offset32 += 5 * 2 * (8 - length);
      offset64 += 5 * (8 - length);
    }
  }
}

const { setSeed, eval2D, eval3D } = OpenSimplex(
  {
    Math,
    Uint16Array,
    Uint32Array,
    Int32Array,
    Float64Array,
  },
  {
    setSeed: (value) => (random.seed = value),
    nextUint32: random.nextUint32,
    print(n) {
      return console.log(n);
    },
  },
  heap
);

let seed = 0;
setSeed(seed);

export default {
  set seed(value) {
    seed = value;
    setSeed(seed);
  },
  get seed() {
    return seed;
  },
  eval2D,
  eval3D,
};
